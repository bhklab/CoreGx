###########
# Travis CI configuration file
# - Enables automated testing on Travis CI web servers
# - Tests activate on push to GitHub
###########

## R CONFIGURATION 
language: r

## R PACKAGE SETTINGS
r_packages:
 - covr
cache: packages

## PARALLEL OS TEST SETTINGS
# - This enables parallel testing of osx and linux on push to GitHub
matrix:
  include:
  ## LINUX SETTINGS
  - r: bioc-devel
    os: linux
    dist: bionic
    ## APT PACKAGE SETTINGS
    addons:
      apt:
        update: true
        packages:
          - x11proto-xf86vidmode-dev
          - tcl8.5-dev
          - tk8.5-dev
          - xvfb
    ## TESTING COMMANDS
    script:
      - R CMD build . --resave-data --compact-vignettes=gs+qpdf
      - travis_wait 30 xvfb-run R CMD check *.tar.gz # `xvfb-run` executes the command inside the xvfb virtual GUI to catch any renders
  ## OSX SETTINGS
  - r: release
    os: osx
    osx_image: xcode11
    ## OSX HOMEBREW PACKAGES
    # - Dependencies for virtual GUI
    before_install:
      - brew update
      - brew cask reinstall xquartz 
      - brew install tcl-tk
      - brew link --overwrite --force tcl-tk; brew unlink tcl-tk
    ## VIRTUAL GUI
    # - Launches virtual GUI to catch renders on the headless test server
    before_script:
      - "export DISPLAY=:99.0"
      - if [ "${TRAVIS_OS_NAME}" = "osx" ]; then ( sudo Xvfb :99 -ac -screen 0 1024x768x8; echo ok ) & fi
    ## TESTING COMMANDS
    script:
      - R CMD build . --resave-data --no-build-vignettes # V
      - travis_wait 30 R CMD check *.tar.gz --no-build-vignettes # `travis_wait 30` increases the maximum time without printing to log from 10 to 30 minutes

# POST TEST COMMANDS
after_success:
- travis_wait 30 Rscript -e 'library(covr);codecov(type="all")' # Calculating code coverage


## NOTIFICATION SETTINGS
notifications:
  slack:
    rooms:
      secure:  UiWDG86JonMFW+DeDBJbB8T2i/ZDJRzp8rpJwYCEoekhNxZOV2vVRbEBevFpriirbMChkEAywcBue+7R0nshc/qpI1ehvBklcU4jXd3lLgGAgEXzoP5mx2CSAXAuPOYcbZaMGw0vFnpyuX8idldqIt5WPrD9s7Ln36/NRjbNGEc9VvDSeih0CVqfUfthOGAER49L5GTW4uIuMLQCv0O1tnOHFLW4zg3m+SZN6kZbNFxtWVVZcUkiiE9yeVuhVm2SEGhJwuPoWi9m9vXXQpXy2MyWTZwtHwUskISlRtxyz79okZQYT03RVBZo1m9IWezh+NHZWhD2ytqhfYqt0Bi8AGMbLrrjfLqidO+uOtgIIU8nSiKGU/weuJzNxCgrHws+La5bs2kSqJkA+6OvjHy/M6OJ3ePLGY1DSpuUrYhslnTDM8TsE6hg0LEuK9JLJbgbJ0BktGEQ3EyfIW95KpqPkJuCFVZdH9ELXJp6o/XFIGTCm2K2yGU8teJJ7HwL2kEL9302VY8i0TouXUy5QXXUrhORGrgh5va5KofTq1ZGDw2kmFc7ArTFPyXmMkZ5YgoQtg7km2lwS3lU2IByIdky95YnOZBERN4TQsY7KOT+jFXLuUwjYiiN5/7iPR5oBZv6OU6ltzPztjY1LYOqLk9A9w+l3JzETDw3g8QVUczFJhw=